{% extends "admin/base_site.html" %}
{% block content %}

<nav>
    {% for crumb in breadcrumb %}
        {% if forloop.first %}
            <a href="{{ crumb.path }}">{{ crumb.name }}</a> /
        {% elif not forloop.last %}
            <a href="?path={{ crumb.path }}">{{ crumb.name }}</a> /
        {% else %}
            {{ crumb.name }}
        {% endif %}
    {% endfor %}
</nav>

<div style="display:flex; flex-direction: row; align-items: center; column-gap: 50px; margin-bottom: 1rem; margin-top: 1rem;">

    <form method="get" style="display:flex; gap: 0.5rem; align-items:center;">
        <input type="hidden" name="path" value="{{ current_path }}">
        <input type="text" name="search_query" placeholder="Search" value="{{ search_query }}">

        <select name="level_filter">
            <option value="">All Levels</option>
            <option value="debug" {% if level_filter == 'debug' %}selected{% endif %}>DEBUG</option>
            <option value="info" {% if level_filter == 'info' %}selected{% endif %}>INFO</option>
            <option value="warning" {% if level_filter == 'warning' %}selected{% endif %}>WARNING</option>
            <option value="error" {% if level_filter == 'error' %}selected{% endif %}>ERROR</option>
            <option value="critical" {% if level_filter == 'critical' %}selected{% endif %}>CRITICAL</option>
        </select>

        <button type="submit" class="button">Search</button>
    </form>

    <a href="?path={{ current_path }}&download=1" class="button">Download file</a>
</div>

{% if rows %}
    <table>
        <thead>
            <tr>
                {% for column_name in column_names %}
                    <th>{{ column_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
                <tr>
                    {% for value in row %}
                        {% if forloop.counter == column_names|length and value %}
                            <td><button type="button" class="button" onclick="toggleTraceback(this)" id="show-traceback-button">Show Traceback</button></td>
                        {% else %}
                            <td>{{ value }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% if row|length == column_names|length and row|last %}
                <tr class="traceback-row">
                    <td colspan="{{ column_names|length }}" style="padding: 5px; border: none;">
                        <div class="traceback-wrapper" style="max-height: 0; overflow: hidden; transition: max-height 0.2s;"> <!-- `max-height` is set inline, so it can be read in the script tag -->
                            <pre>{{ row|last }}</pre>
                        </div>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <pre>{{ content }}</pre>
{% endif %}

<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?path={{ current_path }}&page=1{% if search_query %}&search_query={{ search_query }}{% endif %}{% if level_filter %}&level_filter={{ level_filter }}{% endif %}">Start</a>
        <a href="?path={{ current_path }}&page={{ page_obj.previous_page_number }}{% if search_query %}&search_query={{ search_query }}{% endif %}{% if level_filter %}&level_filter={{ level_filter }}{% endif %}">← Previous</a>
    {% endif %}

    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
        <a href="?path={{ current_path }}&page={{ page_obj.next_page_number }}{% if search_query %}&search_query={{ search_query }}{% endif %}{% if level_filter %}&level_filter={{ level_filter }}{% endif %}">Next →</a>
        <a href="?path={{ current_path }}&page={{ page_obj.paginator.num_pages }}{% if search_query %}&search_query={{ search_query }}{% endif %}{% if level_filter %}&level_filter={{ level_filter }}{% endif %}">End</a>
    {% endif %}
</div>


<style>
thead {
    position: sticky;
    top: 0;
}

thead th {
    text-transform: none;
}

.traceback-wrapper pre {
    overflow-x: auto;
}

a.button,
button.button,
#show-traceback-button {
    font-size: 0.85rem;
    padding: 4px 8px;
}

.pagination {
    margin-top: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.pagination a {
    padding: 4px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}
</style>


<script>
function toggleTraceback(button) {
    const tr = button.closest("tr");
    const wrapper = tr.nextElementSibling.querySelector(".traceback-wrapper");

    if (wrapper.style.maxHeight && wrapper.style.maxHeight !== "0px") {
        wrapper.style.maxHeight = "0";
    } else {
        wrapper.style.maxHeight = wrapper.scrollHeight + "px";
    }
}

document.addEventListener("DOMContentLoaded", function() {

    const theme = document.documentElement.getAttribute("data-theme");
    const levelColorsLight = {
        "debug": "#f0f0f0",
        "info": "#ced9f5",
        "warning": "#fff3cd",
        "error": "#f7c3c9",
        "critical": "#f2919c"
    };
    const levelColorsDark = {
        "debug": "#333333",
        "info": "#3055b3",
        "warning": "#7d661b",
        "error": "#721c24",
        "critical": "#4b0b0b"
    };
    const levelColors = theme === "dark" ? levelColorsDark : levelColorsLight;

    const stringColumnTypes = '{{ column_types|safe|escapejs }}'.replaceAll("'", "\"")
    let columnTypes = JSON.parse(stringColumnTypes);
    columnTypes = columnTypes.map(e => e.toLowerCase());
    levelColumnIndex = columnTypes.indexOf("level");

    if (levelColumnIndex === -1) {
        return;
    }

    document.querySelectorAll("table tbody tr").forEach(tr => {
        const cells = tr.querySelectorAll("td");
        const text = cells[levelColumnIndex].innerText.trim().toLowerCase();
        tr.style.backgroundColor = levelColors[text];
    });
});

</script>

{% endblock %}
